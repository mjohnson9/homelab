# todo: macaroon secret key

synapse:
  serverName: "johnson.gg"
  publicServerName: "matrix.johnson.gg"

  signingkey:
    job:
      enabled: false

    existingSecret: homeserver-keys
    existingSecretKey: signing-key

  config:
    publicBaseurl: "https://matrix.johnson.gg"

    enableRegistration: false

  extraConfig:
    dynamic_thumbnails: true

    email:
      smtp_host: "smtp.smtp"
      enable_tls: false
      notif_from: "%(app)s <matrix@johnson.gg>"
      enable_notifs: true
      client_base_url: "https://chat.johnson.gg"
      invite_client_location: "https://app.element.io"

  synapse:
    extraVolumes:
      - name: extra-secret-config
        secret:
          secretName: extra-secret-config
    extraVolumeMounts:
      - name: extra-secret-config
        mountPath: /run/synapse-extra-secret-config
    extraCommands:
      - "cp -av /run/synapse-extra-secret-config/config.yaml /synapse/config/conf.d/extra-secret-config.yaml"

  wellknown:
    enabled: true

    server:
      m.server: matrix.johnson.gg:443

    client:
      m.homeserver:
        base_url: "https://matrix.johnson.gg"

  externalPostgresql:
    host: "shared-cluster.postgresql"
    database: synapse
    username: matrix.synapse
    existingSecret: "matrix.synapse.shared-cluster.credentials.postgresql.acid.zalan.do"
    existingSecretPasswordKey: password

    sslmode: require

  persistence:
    enabled: true

    accessMode: ReadWriteMany
    size: 64Gi

  ingress:
    enabled: true
    includeServerName: false

    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      hajimari.io/enable: "false"

      # only allow internal clients
      nginx.ingress.kubernetes.io/whitelist-source-range: 10.0.0.0/8

    wkHosts: ["johnson.gg"]
    csHosts: ["matrix.johnson.gg"]
    hosts: ["matrix.johnson.gg"]

    tls:
      - secretName: matrix-tls-certificate
        hosts:
          - matrix.johnson.gg
          - johnson.gg

  postgresql:
    enabled: false
